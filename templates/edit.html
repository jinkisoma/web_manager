<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>데이터 수정</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f9f9f9; }
        h1 { color: #333; }
        .form-section { margin-bottom: 2em; padding: 20px; background-color: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-label { margin-bottom: 5px; font-weight: bold; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-textarea { min-height: 80px; resize: vertical; }
        .submit-btn, .cancel-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; text-decoration: none; display: inline-block; margin-right: 10px; }
        .submit-btn { background-color: #28a745; color: white; }
        .submit-btn:hover { background-color: #218838; }
        .cancel-btn { background-color: #6c757d; color: white; }
        .cancel-btn:hover { background-color: #5a6268; }
        .hidden { display: none; }
        .flash.error { background-color: #f8d7da; color: #721c24; padding: 1em; margin-bottom: 1em; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>데이터 수정 (ID: {{ user.id }})</h1>

    {% if is_readonly %}
    <div class="flash error" style="text-align: center; font-weight: bold;">
        이 데이터는 확정 처리되어 수정할 수 없습니다.
    </div>
    {% endif %}

    <div class="form-section">
        <form action="{{ url_for('update_user', id=user.id) }}" method="post" enctype="multipart/form-data" id="edit-form">
            <input type="hidden" name="current_author" id="current-author-input">
            <input type="hidden" name="override_password" id="override-password-input">
            <div class="form-grid">
                <div class="form-group">
                    <label for="work_date" class="form-label">작업일자</label>
                    <input type="date" id="work_date" name="work_date" class="form-input" value="{{ user.work_date.strftime('%Y-%m-%d') if user.work_date and not user.work_date is string else user.work_date }}" required {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="client_select" class="form-label">거래처</label>
                    <select id="client_select" name="client_select" class="form-select" required {% if is_readonly %}disabled{% endif %}>
                        <option value="">선택하세요</option>
                        {% for client in clients %}
                        <option value="{{ client }}" {% if client == user.client %}selected{% endif %}>{{ client }}</option>
                        {% endfor %}
                        <option value="direct">직접 입력</option>
                    </select>
                    <input type="text" id="client_direct" name="client_direct" class="form-input {% if user.client in clients %}hidden{% endif %}" placeholder="거래처 직접 입력" value="{% if user.client not in clients %}{{ user.client }}{% endif %}" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="work_type_select" class="form-label">작업 구분</label>
                    <select id="work_type_select" name="work_type_select" class="form-select" {% if is_readonly %}disabled{% endif %}>
                        <!-- 자바스크립트로 채워짐 -->
                    </select>
                    <input type="text" id="work_type_direct" name="work_type_direct" class="form-input hidden" placeholder="작업 구분 직접 입력" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="author" class="form-label">작성자</label>
                    <input type="text" id="author" name="author" class="form-input" value="{{ user.author or '' }}" required {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="orderer_select" class="form-label">주문자</label>
                    <select id="orderer_select" name="orderer_select" class="form-select" {% if is_readonly %}disabled{% endif %}></select>
                    <input type="text" id="orderer_direct" name="orderer_direct" class="form-input hidden" placeholder="주문자 직접 입력" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="product_code" class="form-label">업체상품코드</label>
                    <input type="text" id="product_code" name="product_code" class="form-input" value="{{ user.product_code or '' }}" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="product_name" class="form-label">상품명</label>
                    <input type="text" id="product_name" name="product_name" class="form-input" value="{{ user.product_name or '' }}" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="box_quantity" class="form-label">박스수량</label>
                    <input type="number" id="box_quantity" name="box_quantity" class="form-input" value="{{ user.box_quantity or '' }}" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="unit_price" class="form-label">금액(단가)</label>
                    <input type="number" id="unit_price" name="unit_price" class="form-input" value="{{ user.unit_price or '' }}" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="total_amount" class="form-label">합계</label>
                    <input type="text" id="total_amount" name="total_amount" class="form-input" value="{{ user.total_amount | number_format }}" readonly style="text-align: right;" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="quantity" class="form-label">작업수량</label>
                    <input type="number" id="quantity" name="quantity" class="form-input" value="{{ user.quantity or '' }}" {% if is_readonly %}disabled{% endif %}>
                </div>
                <div class="form-group">
                    <label for="tracking_number" class="form-label">송장번호</label>
                    <input type="text" id="tracking_number" name="tracking_number" class="form-input" value="{{ user.tracking_number or '' }}" {% if is_readonly %}disabled{% endif %}>
                </div>
            </div>
            <div style="display: flex; gap: 15px; margin-top: 15px; align-items: flex-start;">
                <div class="form-group" style="flex: 2;">
                    <label for="content" class="form-label">내용</label>
                    <textarea id="content" name="content" class="form-textarea" {% if is_readonly %}disabled{% endif %}>{{ user.content or '' }}</textarea>
                </div>
                <div style="flex: 1;">
                    <div class="form-group">
                        <label class="form-label">현재 첨부파일</label>
                        <div style="padding: 8px; border: 1px solid #eee; border-radius: 4px; background-color: #f8f9fa;">
                            {% if user.attachment %}
                                <a href="{{ url_for('uploaded_file', filename=user.attachment) }}" target="_blank">{{ user.attachment }}</a>
                                {% if not is_readonly %}
                                <div style="margin-top: 5px;">
                                    <input type="checkbox" id="delete_attachment" name="delete_attachment" value="true">
                                    <label for="delete_attachment">기존 파일 삭제</label>
                                </div>
                                {% endif %}
                            {% else %}
                                없음
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="form-label">첨부파일 변경 <small style="font-size: 0.8em; color: #666; font-weight: normal;">(용량큰거 업로드하지 마세요)</small></label>
                        <div class="form-input" style="padding: 4px 8px; border-color: #ADD8E6;">
                            <input type="file" id="attachment" name="attachment" style="border: none; padding: 0;" {% if is_readonly %}disabled{% endif %}>
                            <input type="hidden" name="existing_attachment" value="{{ user.attachment or '' }}">
                        </div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                {% if not is_readonly %}
                <input type="submit" value="수정 완료" class="submit-btn">
                {% endif %}
                <a href="{{ url_for('index') }}" class="cancel-btn">목록으로</a>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInput = document.getElementById('quantity');
            const unitPriceInput = document.getElementById('unit_price');
            const totalAmountInput = document.getElementById('total_amount');
            const clientSelect = document.getElementById('client_select');
            const clientDirect = document.getElementById('client_direct');
            const workTypeSelect = document.getElementById('work_type_select');
            const workTypeDirect = document.getElementById('work_type_direct');
            const ordererSelect = document.getElementById('orderer_select');
            const ordererDirect = document.getElementById('orderer_direct');
            
            function fetchWorkTypes(clientName, selectedWorkType) {
                workTypeSelect.disabled = true;
                workTypeSelect.innerHTML = '<option>불러오는 중...</option>';
                if (!clientName || clientName === 'direct') {
                    workTypeSelect.innerHTML = '<option value="">거래처를 먼저 선택하세요</option>';
                    workTypeSelect.disabled = true;
                    return;
                }

                fetch(`/api/work-items/${clientName}`)
                    .then(response => response.json())
                    .then(data => {
                        workTypeSelect.innerHTML = '<option value="">선택하세요</option>';
                        let workTypeFound = false;
                        for (const workType in data) {
                            const option = new Option(workType, workType);
                            if (workType === selectedWorkType) {
                                option.selected = true;
                                workTypeFound = true;
                            }
                            workTypeSelect.add(option);
                        }
                        
                        if (!workTypeFound && selectedWorkType) {
                            const option = new Option(selectedWorkType, selectedWorkType, true, true);
                            workTypeSelect.add(option);
                        }

                        workTypeSelect.add(new Option('직접 입력', 'direct'));
                        workTypeSelect.disabled = false;
                    });
            }

            clientSelect.addEventListener('change', function() {
                if (this.value === 'direct') {
                    clientDirect.classList.remove('hidden');
                    workTypeSelect.disabled = true;
                    workTypeSelect.innerHTML = '<option value="">거래처를 먼저 선택하세요</option>';
                } else {
                    clientDirect.classList.add('hidden');
                    clientDirect.value = '';
                    fetchWorkTypes(this.value, null);
                }
            });

            workTypeSelect.addEventListener('change', function() {
                if (this.value === 'direct') {
                    workTypeDirect.classList.remove('hidden');
                } else {
                    workTypeDirect.classList.add('hidden');
                    workTypeDirect.value = '';
                }
            });

            function calculateTotal() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const unitPrice = parseFloat(unitPriceInput.value) || 0;
                const total = Math.floor(quantity * unitPrice);
                totalAmountInput.value = total.toLocaleString('en-US');
            }

            quantityInput.addEventListener('input', calculateTotal);
            unitPriceInput.addEventListener('input', calculateTotal);

            // '주문자' 드롭다운 로직
            function setupOrdererField() {
                const existingOrderer = "{{ user.remarks or '' }}";
                // 아래 목록에 주문자를 추가할 수 있습니다.
                const ordererOptions = ['쿠팡', '마켓컬리', '하이마트'];
                let isDirectInput = true;

                ordererSelect.innerHTML = '<option value="">선택하세요</option>';
                ordererOptions.forEach(opt => {
                    const option = new Option(opt, opt);
                    if (opt === existingOrderer) {
                        option.selected = true;
                        isDirectInput = false;
                    }
                    ordererSelect.add(option);
                });
                ordererSelect.add(new Option('직접 입력', 'direct'));

                if (isDirectInput && existingOrderer) {
                    ordererSelect.value = 'direct';
                    ordererDirect.value = existingOrderer;
                    ordererDirect.classList.remove('hidden');
                }
            }

            ordererSelect.addEventListener('change', function() {
                if (this.value === 'direct') {
                    ordererDirect.classList.remove('hidden');
                } else {
                    ordererDirect.classList.add('hidden');
                    ordererDirect.value = '';
                }
            });

            const initialClient = clientSelect.value;
            const initialWorkType = "{{ user.work_type or '' }}";
            fetchWorkTypes(initialClient, initialWorkType);

            // [추가] 소유권 확인을 위해 현재 작성자 이름을 폼에 주입
            const currentAuthor = localStorage.getItem('savedAuthor') || '';
            document.getElementById('current-author-input').value = currentAuthor;

            // [추가] 관리자 권한 확인을 위해 비밀번호를 폼에 주입
            const overridePassword = new URLSearchParams(window.location.search).get('override_password');
            if (overridePassword) {
                document.getElementById('override-password-input').value = overridePassword;
            }

            // 페이지 로드 시 주문자 필드 초기화
            setupOrdererField();
        });

        // [추가] 첨부파일 레이블 클릭 방지
        const attachmentChangeLabel = document.querySelector('label[for="attachment"]');
        if (attachmentChangeLabel) {
            attachmentChangeLabel.addEventListener('click', function(event) {
                // 레이블 클릭 시 파일 선택 창이 열리는 기본 동작을 막습니다.
                event.preventDefault();
            });
        }
    </script>
</body>
</html>